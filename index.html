<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chordotron</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app-container">
        <header>
            <h1>Chordotron</h1>
            <div class="byline">by Crisper (<span style="font-size: xx-small;">and Gemini 2.5 Pro</span>)</div>
            <div class="version">v0.9.0</div>
        </header>

        <fieldset id="appActionsFieldset">
            <div class="app-actions-bar">
                <div class="action-group file-actions">
                    <button id="restoreDefaultsButton" title="Create a new song (resets settings)">üìÑ New</button>
                    <button id="loadSettingsButton" title="Load song settings from a file">üìÅ Load</button>
                    <input type="file" id="loadSettingsFile" accept=".json" style="display: none;">
                    <button id="saveSettingsButton" title="Save current song settings">üíæ Save</button>
                    <button id="helpButton" title="Show help guide">‚ùì Help</button>
                </div>
            </div>
        </fieldset>

        <main class="main-content">
            <section class="input-section">
                <fieldset id="mainControlsFieldset">
                    <h2>‚úèÔ∏è Input</h2>
                    <div class="input-mode-selector">
                        <label><input type="radio" name="inputMode" value="chords" checked> üéµ Chord Names</label>
                        <label><input type="radio" name="inputMode" value="degrees"> üéº Scale Degrees</label>
                    </div>

                    <div id="chordNameInputArea">
                        <label for="chordInput">Chord Progression:</label>
                        <textarea id="chordInput" rows="15" style="resize: none;" placeholder="E(8) C#m(8) A(8) B(8)"></textarea>
                    </div>

                    <div id="scaleDegreeInputArea" style="display:none;">
                        <div class="key-selection-grid">
                            <div>
                                <label for="songKey">Song Key:</label>
                                <select id="songKey">
                                    <option value="C">C</option>
                                    <option value="C#">C# / Db</option>
                                    <option value="D">D</option>
                                    <option value="D#">D# / Eb</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="F#">F# / Gb</option>
                                    <option value="G">G</option>
                                    <option value="G#">G# / Ab</option>
                                    <option value="A">A</option>
                                    <option value="A#">A# / Bb</option>
                                    <option value="B">B</option>
                                </select>
                            </div>
                            <div>
                                <label for="keyMode">Mode:</label>
                                <select id="keyMode">
                                    <option value="ionian" selected>Ionian (Major)</option>
                                    <option value="dorian">Dorian</option>
                                    <option value="phrygian">Phrygian</option>
                                    <option value="lydian">Lydian</option>
                                    <option value="mixolydian">Mixolydian</option>
                                    <option value="aeolian">Aeolian (Nat. Minor)</option>
                                    <option value="locrian">Locrian</option>
                                    <option value="harmonicMinor">Harmonic Minor</option>
                                    <option value="melodicMinor">Melodic Minor (Asc)</option>
                                </select>
                            </div>
                        </div>
                        <label for="scaleDegreeInput">Scale Degrees:</label>
                        <textarea id="scaleDegreeInput" rows="15" style="resize: none;" placeholder="I(2) V(2) vi(2) iii(2) IV(2) I(2) IV(2) V(2)"></textarea>
                    </div>
                </fieldset>
            </section>

            <section class="parameters-section">
                <fieldset id="parametersControlsFieldset">
                    <h2>‚öôÔ∏è Parameters</h2>
                    <div class="parameters-columns">
                        <div class="control-group timing-group">
                            <h3>‚è±Ô∏è Timing</h3>
                            <label for="bpm">BPM: <span id="bpmValue">120</span></label>
                            <input type="range" id="bpm" value="120" min="30" max="300" step="1">

                            <label for="timeSignature">Time Signature:</label>
                            <select id="timeSignature">
                                <option value="2/4">2/4</option>
                                <option value="3/4">3/4</option>
                                <option value="4/4" selected>4/4</option>
                                <option value="5/4">5/4</option>
                                <option value="6/8">6/8</option>
                                <option value="9/8">9/8</option>
                                <option value="12/8">12/8</option>
                            </select>
                        </div>

                        <div class="control-group synth-controls-group">
                            <h3>üéπ Synth</h3>
                            <div class="oscillator-control-inline">
                                <label for="oscillatorType">Oscillator:</label>
                                <select id="oscillatorType">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="sawtooth">Sawtooth</option>
                                    <option value="triangle" selected>Triangle</option>
                                </select>
                            </div>
                            
                            <div class="adsr-section">
                                <label class="section-sub-label">Envelope (ADSR) & Gain:</label>
                                <div class="adsr-canvas-container">
                                    <canvas id="adsrCanvas" width="200" height="100"></canvas>
                                </div>
                                <div class="adsr-knobs-container">
                                    <div class="knob-control">
                                        <label for="attack" class="knob-label-top">Attack</label>
                                        <input type="range" id="attack" class="adsr-knob" value="0.05" min="0.01" max="2" step="0.01" orient="vertical">
                                        <span id="attackValue" class="knob-value">0.05</span>
                                    </div>
                                    <div class="knob-control">
                                        <label for="decay" class="knob-label-top">Decay</label>
                                        <input type="range" id="decay" class="adsr-knob" value="0.1" min="0.01" max="2" step="0.01" orient="vertical">
                                        <span id="decayValue" class="knob-value">0.1</span>
                                    </div>
                                    <div class="knob-control">
                                        <label for="sustain" class="knob-label-top">Sustain</label>
                                        <input type="range" id="sustain" class="adsr-knob" value="0.7" min="0" max="1" step="0.01" orient="vertical">
                                        <span id="sustainValue" class="knob-value">0.7</span>
                                    </div>
                                    <div class="knob-control">
                                        <label for="release" class="knob-label-top">Release</label>
                                        <input type="range" id="release" class="adsr-knob" value="0.3" min="0.01" max="3" step="0.01" orient="vertical">
                                        <span id="releaseValue" class="knob-value">0.3</span>
                                    </div>
                                    <div class="knob-control">
                                        <label for="synthGain" class="knob-label-top">Gain</label>
                                        <input type="range" id="synthGain" class="adsr-knob" value="0.5" min="0" max="1" step="0.01" orient="vertical">
                                        <span id="synthGainValue" class="knob-value">0.5</span>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="control-group sound-options-group"> 
                            <h3>üîä Master & Metronome</h3>
                            <label for="masterGain">Master Gain: <span id="masterGainValue">0.5</span></label>
                            <input type="range" id="masterGain" value="0.5" min="0" max="1" step="0.01">
                            <label for="metronomeVolume">Metronome Vol Adj: <span id="metronomeVolumeValue">0.8</span></label>
                            <input type="range" id="metronomeVolume" value="0.8" min="0" max="1" step="0.01">
                        </div>

                        <div class="control-group voicing-pitch-range-group">
                            <h3>‚ÜîÔ∏è Pitch Range</h3>
                            <div>
                                <label for="rangeStartNoteSlider">Range Start: <span id="rangeStartNoteValue">C3</span></label>
                                <input type="range" id="rangeStartNoteSlider" value="48" min="36" max="72" step="1">
                            </div>
                            <div>
                                <label for="rangeLengthSlider">Range Length (semitones): <span id="rangeLengthValue">24</span></label>
                                <input type="range" id="rangeLengthSlider" value="24" min="12" max="24" step="1">
                            </div>
                            <div class="range-display">
                                Current Range: <span id="currentRangeDisplay">C3 - B4</span>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </section>
        </main>

        <section class="keyboard-section">
            <div id="pianoKeyboardContainer" class="piano-keyboard-container">
            </div>
        </section>

        <footer class="playback-footer">
            <div class="chord-context-display prev-chord">
                <div class="context-chord" id="prevChordDisplay">‚èÆÔ∏è Prev: --</div>
            </div>

            <div class="main-playback-wrapper">
                <div class="main-playback-controls">
                    <div class="playback-option-toggle button-style-toggle">
                        <input type="checkbox" id="loopToggle" name="loopToggle">
                        <label for="loopToggle" class="toggle-button">üîÅ Loop</label>
                    </div>
                    <button id="playStopButton">‚ñ∂Ô∏è Play</button>
                    <div class="playback-option-toggle button-style-toggle">
                        <input type="checkbox" id="metronomeAudioToggle" name="metronomeAudioToggle">
                        <label for="metronomeAudioToggle" class="toggle-button">ü•Å Metro</label>
                    </div>
                </div>

                <div class="main-playback-info">
                    <div id="currentChordDisplay">üé∂ Playing: --</div>
                    <div id="beatIndicatorContainer">
                    </div>
                </div>
            </div>

            <div class="chord-context-display next-chord">
                <div class="context-chord" id="nextChordDisplay">Next: ‚è≠Ô∏è --</div>
            </div>
        </footer>
    </div>

    <div id="helpModalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal-content">
            <button id="modalCloseButton" class="modal-close-button" title="Close Help" aria-label="Close help dialog">√ó</button>
            <h2 id="helpModalTitle">Chordotron - Quick Start Guide</h2>
            
            <div class="modal-section">
                <h3>What is Chordotron?</h3>
                <p>Chordotron is a web-based tool to quickly prototype, play, and experiment with chord progressions. You can input chords directly or use scale degrees, adjust timing, synth sounds, and playback parameters.</p>
            </div>

            <div class="modal-section">
                <h3>1. Inputting Your Progression</h3>
                <p>Choose your input method:</p>
                <ul>
                    <li><strong>üéµ Chord Names:</strong> Enter standard chord notation.
                        <ul>
                            <li>Example: <code>Cmaj7(4) G/B(4) Am7(4) F(4)</code></li>
                            <li><code>(4)</code> denotes the duration in beats (optional, defaults to beats per measure).</li>
                            <li>Slash chords like <code>G/B</code> (G major with B in the bass) are supported.</li>
                            <li>Supported qualities include: <code>m, maj, M, dim, aug, sus4, sus2, 7, maj7, m7, dim7, o, √∏, +</code>, and more complex extensions (9, 11, 13).</li>
                        </ul>
                    </li>
                    <li><strong>üéº Scale Degrees:</strong> Enter Roman numerals relative to a chosen key and mode.
                        <ul>
                            <li>Example: <code>I(2) V(2) vi(2) IV(2)</code> in C Major.</li>
                            <li>Set the <strong>Song Key</strong> (e.g., C, G#, Eb) and <strong>Mode</strong> (e.g., Ionian/Major, Aeolian/Minor, Dorian).</li>
                            <li>Accidentals: <code>bII</code>, <code>#IV</code>.</li>
                            <li>Slash chords (applied chords or bass notes): <code>V/iii</code>.</li>
                            <li>Explicit qualities: <code>Im7</code>, <code>V7</code>. If no quality is given, a diatonic quality is assumed.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>2. Setting Parameters (‚öôÔ∏è)</h3>
                <ul>
                    <li><strong>‚è±Ô∏è Timing:</strong>
                        <ul>
                            <li><strong>BPM:</strong> Beats Per Minute.</li>
                            <li><strong>Time Signature:</strong> e.g., 4/4, 3/4, 6/8. This affects default chord duration and metronome.</li>
                        </ul>
                    </li>
                    <li><strong>üéπ Synth:</strong>
                        <ul>
                            <li><strong>Oscillator:</strong> Waveform (Sine, Square, Sawtooth, Triangle).</li>
                            <li><strong>Envelope (ADSR):</strong> Attack, Decay, Sustain, Release times for the sound's shape. Use vertical sliders.</li>
                            <li><strong>Gain:</strong> Volume of the synth sound itself.</li>
                        </ul>
                    </li>
                    <li><strong>üîä Master & Metronome:</strong>
                        <ul>
                            <li><strong>Master Gain:</strong> Overall output volume.</li>
                            <li><strong>Metronome Vol Adj:</strong> Adjusts metronome volume relative to master gain.</li>
                        </ul>
                    </li>
                    <li><strong>‚ÜîÔ∏è Pitch Range:</strong>
                        <ul>
                            <li><strong>Range Start & Length:</strong> Defines the allowed MIDI note range for voiced chords. The keyboard below will highlight this range. Chords are voiced to fit within these boundaries.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>3. Playback Controls (Footer)</h3>
                <ul>
                    <li><strong>‚ñ∂Ô∏è Play / ‚èπÔ∏è Stop:</strong> Starts or stops playback. (Keyboard Shortcut: Spacebar)</li>
                    <li><strong>üîÅ Loop:</strong> Toggles looping of the entire progression.</li>
                    <li><strong>ü•Å Metro:</strong> Toggles the audible metronome click.</li>
                    <li><strong>Chord Display:</strong> Shows previous, current, and next chords.</li>
                    <li><strong>Beat Indicators:</strong> Visual cue for beats in the current measure.</li>
                </ul>
            </div>
             <div class="modal-section">
                <h3>4. Keyboard (Middle Section)</h3>
                 <p>The piano keyboard visualizes the notes being played for the current chord and highlights the selected <strong>Pitch Range</strong>.</p>
            </div>

            <div class="modal-section">
                <h3>5. File Operations (Top Bar)</h3>
                <ul>
                    <li><strong>üìÑ New:</strong> Resets all settings and inputs to default.</li>
                    <li><strong>üìÅ Load:</strong> Load a previously saved song/settings (<code>.json</code> file).</li>
                    <li><strong>üíæ Save:</strong> Save your current inputs and all parameter settings as a <code>.json</code> file.</li>
                    <li><strong>‚ùì Help:</strong> Shows this guide again.</li>
                </ul>
            </div>
             <div class="modal-section">
                <h3>Tips</h3>
                <ul>
                    <li>Use the <strong>Spacebar</strong> to quickly Play/Stop.</li>
                    <li>You can play a <strong>selection</strong> of your input by highlighting text in the Chord/Degree input area before pressing Play.</li>
                    <li>Experiment with ADSR and Oscillator types to create different timbres!</li>
                    <li>The pitch range affects how chords are voiced. Wider ranges give more options.</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module" src="main.js" defer></script>
</body>

</html>